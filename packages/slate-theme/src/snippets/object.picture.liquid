{% comment %}
  Picture
    Picture snippet to create a picture element with multiple scales and sizes.

  Settings:
    image - Image to add elements for.
    alt (Optional) - Optional ALT Tag for passed Image URLs
    width (Optional) - The width of the image in pixels (defaults to 1400)
    sizes (Optional) - Sizes for the sourcesets, default is 500,750 and 1000
    imagesizes (Optional) - Allow more granular control on the size of the image generated by shopify for each size passed with sizes above. Default it's the sizes array
    class (Optional) - Additional class(es) to attach to the img element.

  Version:
    2.0.0 - 2020/07/01

{% endcomment %}

{% unless reduce %}{% assign reduce = 1 %}{% endunless %}
{%-unless width-%}{%-assign width = 1400-%}{%-endunless-%}
{%-unless sizes-%}{%-assign sizes = '500,750,1000,1500'-%}{%-endunless-%}
{%-unless imageSizes-%}{%-assign imageSizes = sizes-%}{%-endunless-%}

{%-assign sizes_spl = sizes | split: ','-%}
{%-assign imageSizes_spl = imageSizes | split: ','-%}

{%-assign image_alt = '' -%}
{%- if alt -%}
  {%-assign image_alt = alt -%}
{%- elsif image.alt != blank -%}
  {%- assign image_alt = image.alt -%}
{%- elsif product.title != blank -%}
  {%- assign image_alt = product.title -%}
{%- elsif product_title != blank -%}
  {%- assign image_alt = product_title -%}
{%- endif -%}

{%- if image.src == blank and image.preview_image != blank -%}
  {%- assign image = image.preview_image -%}
{%- endif -%}

{%- if image == blank -%}
  <picture>
    <img
      src="{{ 'no-image.gif' | img_url: '1200x', scale: 2 }}"
      {% if image_alt != blank %}alt="{{ image_alt | escape }}"{% endif %}
      {% if class != blank -%}class="{{class}}"{% endif %}
      {% if attributes != blank %}{{ attributes }}{% endif %}
    />
  </picture>
{%- elsif image.src == blank and image contains 'cdn.shopify.com' -%}
  {% comment %}
    Handle cases where we've been supplied a raw shopify cdn image.
    This is good for metafields app that use a theme to hold the image assets.
  {% endcomment %}

  {%- assign splitByQuestionMark = image | split: '?' -%}
  {%- assign withoutQuestionMark = splitByQuestionMark[0] -%}
  {%- assign splitByProtocol = withoutQuestionMark | split: '://' -%}
  {%- if splitByProtocol[0] contains 'http' -%}
    {%- assign withoutProtocol = '//' | append: splitByProtocol[1] -%}
  {%- else -%}
    {%- assign withoutProtocol = '//' | append: splitByProtocol[0] -%}
  {%- endif -%}

  {% comment %}
    Now we gotta split by dot, this will give us the file extension
  {% endcomment %}
  {%- assign splitByDot = withoutProtocol | split: '.' -%}
  {%- assign ext = splitByDot.last -%}
  {%- assign dext = '.' | append: ext -%}
  {%- assign sizeMinusExtension = withoutProtocol.size | minus: dext.size -%}
  {%- assign path = withoutProtocol | slice: 0, sizeMinusExtension -%}

  {%- comment -%}
    Now we split by _, this will let us take any size params such as _master etc.
  {%- endcomment -%}
  {%- assign splitByUndersore = path | split: '_' -%}
  {%- assign pathNoSize = path -%}
  {%- if splitByUndersore.size > 1 -%}
    {%- assign size = splitByUndersore.last -%}
    {%- assign hasSize = false -%}
    {%- case size -%}
      {%- when 'small' -%}
        {%- assign hasSize = true -%}
      {%- when 'medium' -%}
        {%- assign hasSize = true -%}
      {%- when 'large' -%}
        {%- assign hasSize = true -%}
      {%- when 'master' -%}
        {%- assign hasSize = true -%}
      {%- else -%}
        {% comment %}
          Having problems with clients' images? Check they don't have an x in
          the filename!
        {% endcomment %}
        {%- if size contains 'x' -%}
          {%- assign hasSize = true -%}
        {%- endif -%}
    {%- endcase -%}

    {%- if hasSize -%}
      {%- assign sizeMinusSize = path.size | minus: size.size | minus: 1 -%}
      {%- assign pathNoSize = path | slice: 0, sizeMinusSize -%}
    {%- endif -%}
  {%- endif -%}

  {% comment %} Now we have the bits we need to start formatting custom sizes. {% endcomment %}
  <picture>
    {%-for size in sizes_spl-%}
      {% assign index = forloop.index | minus: 1 %}
      {% assign  imageSize = imageSizes_spl[index] %}
      {%-assign w = imageSize   | prepend: '_' | append: 'x' -%}
      <source
        media="(max-width:{{size}}px)"
        srcset="{{ pathNoSize | append: w | append: dext -}}, {{ pathNoSize | append: w | append: '@2x' | append: dext }} 2x, {{ pathNoSize | append: w | append: '@4x' | append: dext }} 4x"
        {%- if image_alt != blank -%}alt="{{ image_alt | escape }}"{%- endif -%}
      />
    {%-endfor-%}

    {%-assign w = width   | prepend: '_'  | append:'x'-%}
    {%-if sizes_spl.last -%}
      <source
        media="(min-width:{{sizes_spl | last}}px)"
        srcset="{{ pathNoSize | append: w | append: dext -}}, {{ pathNoSize | append: w | append: '@2x' | append: dext }} 2x, {{ pathNoSize | append: w | append: '@4x' | append: dext }} 4x"
        {%- if image_alt != blank -%}alt="{{ image_alt | escape }}"{%- endif -%}
      />
    {%-endif-%}

    <img
      src="{{ pathNoSize | append: w | append: dext }}"
      {% if image_alt != blank %}alt="{{ image_alt | escape }}"{% endif %}
      {% if class != blank -%}class="{{class}}"{% endif %}
      {% if attributes != blank %}{{ attributes }}{% endif %}
    />
  </picture>


{%- elsif image.cloudinary_src != blank or image.first.cloudinary_src != blank -%}
  {%- assign path = image.first.cloudinary_src | default: image.cloudinary_src -%}

  <picture>
    {%-for size in sizes_spl-%}
      {% assign index = forloop.index | minus: 1 %}
      {% assign  imageSize = imageSizes_spl[index] %}
      {%-assign w = imageSize | prepend: 'w_' -%}
      <source
        media="(max-width:{{size}}px)"
        srcset="{{ path }}{{ w }}, {{ path }}{{ w }}/dpr_2.0 2x, {{ path }}{{ w }}/dpr_2.0 4x"
        {%- if image_alt != blank -%}alt="{{ image_alt | escape }}"{%- endif -%}
      />
    {%-endfor-%}

    {%-assign w = width   | prepend: 'w_' -%}
    {%-if sizes_spl.last -%}
      <source
        media="(min-width:{{sizes_spl | last}}px)"
        srcset="{{ path }}{{ w }}, {{ path }}{{ w }}/dpr_2.0 2x, {{ path }}{{ w }}/dpr_4.0 4x"
        {%- if image_alt != blank -%}alt="{{ image_alt | escape }}"{%- endif -%}
      />
    {%-endif-%}

    <img
      src="{{ path | append: w }}"
      {% if image_alt != blank %}alt="{{ image_alt | escape }}"{% endif %}
      {% if class != blank -%}class="{{class}}"{% endif %}
      {% if attributes != blank %}{{ attributes }}{% endif %}
    />
  </picture>


{%- elsif image.src == blank -%}

  {% comment %}
    Handle cases where just an image URL was passed
  {% endcomment %}
  <picture>
    <img
      src="{{ image }}"
      {%- if image_alt != blank -%}alt="{{ image_alt | escape }}"{%- endif -%}
      {%-if class != blank -%}class="{{class}}"{%-endif-%}
    />
  </picture>



{%- else -%}
  <picture>
    {%-for size in sizes_spl-%}
      {% assign index = forloop.index | minus: 1 %}
      {% assign imageSize = imageSizes_spl[index] %}
      {%-assign w = imageSize | append: 'x' -%}
      <source
        media="(max-width:{{size}}px)"
        srcset="{{ image | img_url: w -}}, {{ image | img_url: w, scale: '2x'  }} 2x, {{ image | img_url: w, scale: '4x' }} 4x"
        {%- if image_alt != blank -%}alt="{{ image_alt | escape }}"{%- endif -%}
      />
    {%-endfor-%}

    {%-assign w = width  | append:'x'-%}
    {%-if sizes_spl.last -%}
      <source
        media="(min-width:{{sizes_spl | last}}px)"
        srcset="{{ image | img_url: w -}}, {{ image | img_url: w, scale: '2x' }} 2x, {{ image | img_url: w, scale: '4x' }} 4x"
        {%- if image_alt != blank -%}alt="{{ image_alt | escape }}"{%- endif -%}
      />
    {%-endif-%}
    <img
      src="{{ image | img_url: w }}"
      width="{{ image.width }}"
      height="{{ image.height }}"
      {% if image_alt != blank %}alt="{{ image_alt | escape }}"{% endif %}
      {% if class != blank -%}class="{{class}}"{% endif %}
      {% if attributes != blank %}{{ attributes }}{% endif %}
    />
  </picture>

{%- endif -%}
