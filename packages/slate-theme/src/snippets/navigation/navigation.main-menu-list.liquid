{% if links.size > 0 -%}
  {% assign nextLevel = level | plus: 1 %}

  <ul class="c-main-menu__menu is-level-{{ level }}" data-header-menu>
    <li class="c-main-menu__menu-header">
      {% if level == 0 %}
        <form action="{{ routes.search_url }}" class="c-main-menu__search">
          <button type="submit" class="c-main-menu__search-button">
            {%- render 'icon.search' -%}
          </button>

          <input name="q" value="{{ search.terms | escape }}"
            type="text" placeholder="{{ 'general.navigation.search' | t }}"
            class="c-main-menu__search-input o-heading--6"
          />
        </form>
      {% else %}
        <button class="c-main-menu__back" type="button" data-header-back>
          {%- render 'icon.arrow-left' -%}
          {{ parent.title | escape }}
        </button>
      {% endif %}
    </li>

    {%- for link in links -%}
      <li class="c-main-menu__menu-item is-level-{{ level }}">
        <a href="{{ link.url }}" class="c-main-menu__menu-link o-heading--6
          is-level-{{ level }}
          {% if link.links.size > 0 %}has-submenu" data-header-link{% else %}"{% endif %}
        >
          {%- liquid
            echo link.title | escape
            if link.links.size > 0
              render 'icon.arrow-right'
            endif
          -%}
        </a>

        {%- render 'navigation.main-menu-list' with {
          links: link.links,
          parent: link,
          level: nextLevel,
          blocks: blocks
        } -%}
      </li>
    {%- endfor -%}

    {% if level == 0 %}
      {% capture extraLinks %}
        {% if section.settings.wishlist != blank %}
          <li class="c-main-menu__menu-extra">
            <a href="{{ section.settings.wishlist }}"
              class="c-main-menu__menu-link is-footer o-heading--6"
          >
              {%- render 'icon.heart' -%}
              <span>{{ 'general.navigation.wishlist' | t }}</span>
            </a>
          </li>
        {% endif %}

        {% if shop.customer_accounts_enabled %}
          <li class="c-main-menu__menu-extra">
            <a href="{{ routes.account_url }}"
              class="c-main-menu__menu-link is-footer o-heading--6"
            >
              {%- render 'icon.account' -%}
              <span>{{ 'general.navigation.account' | t }}</span>
            </a>
          </li>
        {% endif %}

        <li class="c-main-menu__menu-extra">
          <span class="c-main-menu__menu-link is-footer o-heading--6">
            {{ 'general.navigation.currency' | t }}
            {%- render 'object.currency-selector' -%}
          </span>
        </li>
      {% endcapture %}

      {% if extraLinks != blank %}
        <li class="c-main-menu__menu-spacer">
          <span class="c-main-menu__menu-link o-heading--6">&nbsp;</span>
        </li>
        {{ extraLinks }}
      {% endif %}
    {% elsif level == 1 %}
      {%- liquid
        assign pDown = parent.title | downcase
        capture blockImages
          for block in section.blocks
            assign bDown = block.settings.title | downcase
            if pDown != bDown
              continue
            endif

            if block.settings.image == blank or block.settings.label == blank
              continue
            endif

            capture contents
              render 'tool.picture' with { img: block.settings.image, sizes: '500,750,1000', screens: '1000,1200', class: 'c-main-menu__block-image' }
              echo '<span class="c-main-menu__block-title o-heading--6">'
              echo block.settings.label | escape
              echo '</span>'

              if block.settings.subtitle != blank
                echo '<span class="c-main-menu__block-subtitle o-heading--6">'
                echo block.settings.subtitle | escape
                echo '</span>'
              endif
            endcapture

            if block.settings.link == blank
              echo '<div class="c-main-menu__block-item">'
              echo contents
              echo '</div>'
            else 
              echo '<a href="#" class="c-main-menu__block-item">'
              echo contents
              echo '</a>'
            endif
          endfor
        endcapture

        if blockImages != blank
          echo '<li class="c-main-menu__block">'
          echo blockImages
          echo '</li>'
        endif
      -%}
    {% endif %}
  </ul>
{%- endif %}